---
- name: Run Prowler Docker Container using AWX Credentials
  hosts: localhost
  become: True
  gather_facts: no

  vars_prompt:
    - name: choice
      prompt: "Choose an option (1 to run with Access Key/Secret, anything else to skip):"
      private: no

  tasks:
    - name: Start Prowler Execution
      debug:
        msg: "Starting Prowler execution..."

    - name: Validate user choice
      block:
        - fail:
            msg: "Invalid choice. Please choose '1' to run or any other key to skip."
          when: choice not in ['1']

        - debug:
            msg: "User chose option {{ choice }}."

    - name: Execute Prowler commands for elb using credentials from AWX and generate CSV output
      shell: |
        AWS_ACCESS_KEY_ID={{ lookup('env', 'AWS_ACCESS_KEY_ID') }} \
        AWS_SECRET_ACCESS_KEY={{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }} \
        prowler aws --services elb -M csv
      register: prowler_output
      when: choice == '1'
      ignore_errors: yes

    - name: Display Prowler output
      debug:
        msg: "Prowler command executed. Output:"
      when: prowler_output.stdout | length > 0

    - name: Find the CSV file
      find:
        paths: "/runner/project/output/"
        patterns: "prowler-output-*.csv"
      register: csv_file

    - name: Display found CSV file
      debug:
        msg: "Found CSV file: {{ csv_file.files[0].path }}"
      when: csv_file.matched > 0

    - name: Read the CSV file
      command: cat "{{ csv_file.files[0].path }}"
      register: csv_output
      when: csv_file.matched > 0

    - name: Display the CSV output of Prowler commands
      debug:
        msg: "{{ csv_output.stdout }}"
      when: csv_output.stdout | length > 0

    - name: Display using the echo command
      shell: echo "{{ prowler_output.stdout }}"

    - name: Display Prowler version
      shell: prowler --version
      register: prowler_version_output

    - name: Display Prowler version output
      debug:
        msg: "Prowler version: {{ prowler_version_output.stdout }}"

    - name: Execution Complete
      debug:
        msg: "Prowler execution completed successfully."
