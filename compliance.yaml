# Find the JSON file (both for Choice 1 and 2)
- name: Find the JSON file
  find:
    paths: "/runner/project/output/"
    patterns: "prowler-output-*.json"
  register: json_file

# Check if JSON file exists before renaming
- name: Fail if no JSON file was found
  fail:
    msg: "No JSON file found for renaming."
  when: json_file.matched == 0

# Rename the JSON file from prowler-output to healthcheck-output
- name: Rename JSON file from prowler-output to healthcheck-output
  command: mv "{{ json_file.files[0].path }}" "{{ json_file.files[0].path | regex_replace('prowler', 'healthcheck') }}"
  register: renamed_file
  when: json_file.matched > 0

# Use the new path for the renamed file
- name: Set fact for renamed file path
  set_fact:
    renamed_file_path: "{{ json_file.files[0].path | regex_replace('prowler', 'healthcheck') }}"
  when: json_file.matched > 0

# Read the renamed JSON file before upload
- name: Read the renamed JSON file
  command: cat "{{ renamed_file_path }}"
  register: json_output
  when: json_file.matched > 0

# Upload the renamed JSON file to Backend API
- name: Upload JSON to Backend API
  uri:
    url: "{{ api_url }}"
    method: POST
    headers:
      apiToken: "698f44ff2fd553340c1a8e5b30c39611074abb91abfd0fc8e372fac6d4a8eb42"
      Content-Type: "multipart/form-data"
    body_format: form-multipart
    body:
      file: 
        content: "{{ lookup('file', renamed_file_path) }}"  # Reading the renamed JSON file content
        filename: "{{ renamed_file_path | basename }}"
  register: upload_response
  when: json_file.matched > 0
